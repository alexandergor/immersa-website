<!DOCTYPE html>
<html lang="{{ page.lang | default: 'en' }}" dir="{{ page.dir | default: 'ltr' }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Space+Grotesk:wght@600;700&display=swap"
        rel="stylesheet">
    <!-- Hebrew Font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ '/css/main.css' | relative_url }}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ '/assets/images/favicon.png' | relative_url }}">

    <!-- Social Meta -->
    <meta property="og:title" content="{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}">
    <meta property="og:description" content="{{ page.description | default: site.description }}">
    <meta property="og:image" content="{{ '/assets/images/og-image.png' | relative_url }}">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdqIWYsAAAAAOoe-2FeQQ6BA1-nImj5peDS7QMz" async defer></script>

    {% seo %}
</head>

<body>
    <div class="void-background-fx"></div>

    <header class="site-header">
        <div class="container header-container">
            <a href="{{ '/' | relative_url }}{% if page.lang == 'he' %}he/{% endif %}" class="site-logo">
                <img src="{{ '/assets/images/logo-primary.png' | relative_url }}" alt="{{ site.title }}"
                    class="logo-img">
            </a>

            {% assign nav_t = site.data.translations[page.lang].nav %}
            <nav class="site-nav">
                <button class="nav-toggle" aria-expanded="false" aria-label="{{ nav_t.toggle_menu }}">
                    <span class="hamburger"></span>
                </button>
                <ul class="nav-menu">
                    <li><a href="{{ '/' | relative_url }}{% if page.lang == 'he' %}he/{% endif %}">{{ nav_t.home }}</a>
                    </li>
                    <li><a href="{{ '/' | relative_url }}{% if page.lang == 'he' %}he/{% endif %}about/">{{ nav_t.about
                            }}</a></li>
                    <li><a href="{{ '/' | relative_url }}{% if page.lang == 'he' %}he/{% endif %}waitlist/">{{
                            nav_t.waitlist }}</a></li>
                    <li class="lang-switcher">
                        {% if page.lang == 'en' %}
                        <a href="{{ '/he' | relative_url }}{{ page.url }}" class="lang-link">עברית</a>
                        {% else %}
                        <a href="{{ page.url | remove: '/he' | remove: 'he/' }}"
                            class="lang-link">English</a>
                        {% endif %}
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="main-content">
        {{ content }}
    </main>

    <footer class="site-footer">
        <div class="container">
            {% assign foot_t = site.data.translations[page.lang].footer %}
            <div class="stealth-indicator">
                <span class="status-dot pulsing"></span>
                <span>{{ foot_t.stealth }}</span>
            </div>
            <p class="copyright">&copy; {{ 'now' | date: '%Y' }} {{ site.title }}. {{ foot_t.rights }}</p>
        </div>
    </footer>

    <script>
        // Mobile Menu Toggle
        document.querySelectorAll('.nav-toggle').forEach(function(toggle) {
            toggle.addEventListener('click', function () {
                const expanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !expanded);
                document.querySelector('.nav-menu').classList.toggle('is-open');
            });
        });

        // Custom Dropdown Functionality
        document.querySelectorAll('.custom-select').forEach(function(select) {
            var trigger = select.querySelector('.select-trigger');
            var options = select.querySelector('.select-options');
            var optionElements = select.querySelectorAll('.select-option');
            var hiddenInput = select.querySelector('input[type="hidden"]');
            var valueDisplay = select.querySelector('.select-value');

            // Toggle dropdown
            trigger.addEventListener('click', function() {
                var isOpen = trigger.getAttribute('aria-expanded') === 'true';
                trigger.setAttribute('aria-expanded', !isOpen);
            });

            // Handle option selection
            optionElements.forEach(function(option) {
                option.addEventListener('click', function() {
                    var value = this.getAttribute('data-value');
                    var text = this.textContent;

                    // Update display and hidden input
                    valueDisplay.textContent = text;
                    valueDisplay.classList.remove('placeholder');
                    trigger.classList.add('has-value');
                    hiddenInput.value = value;

                    // Clear error state
                    trigger.classList.remove('error');
                    trigger.style.borderColor = '';

                    // Update selected state
                    optionElements.forEach(function(opt) {
                        opt.classList.remove('selected');
                        opt.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('selected');
                    this.setAttribute('aria-selected', 'true');

                    // Close dropdown
                    trigger.setAttribute('aria-expanded', 'false');
                });

                // Keyboard navigation
                option.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            // Close when clicking outside
            document.addEventListener('click', function(e) {
                if (!select.contains(e.target)) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });
        });

        // Email Validation with Regex
        document.querySelectorAll('input[type="email"]').forEach(function(emailInput) {
            emailInput.addEventListener('blur', function() {
                var email = this.value.trim();
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    this.setCustomValidity('Please enter a valid email address');
                    this.style.borderColor = '#ef4444';
                } else {
                    this.setCustomValidity('');
                    this.style.borderColor = '';
                }
            });

            emailInput.addEventListener('input', function() {
                if (this.style.borderColor === 'rgb(239, 68, 68)') {
                    var email = this.value.trim();
                    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    
                    if (emailRegex.test(email)) {
                        this.setCustomValidity('');
                        this.style.borderColor = '';
                    }
                }
            });
        });

        // Form submission validation
        document.querySelectorAll('form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                var emailInput = form.querySelector('input[type="email"]');
                var roleInput = form.querySelector('input[name="role"]');
                
                if (emailInput) {
                    var email = emailInput.value.trim();
                    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    
                    if (!emailRegex.test(email)) {
                        e.preventDefault();
                        emailInput.style.borderColor = '#ef4444';
                        emailInput.focus();
                        return;
                    }
                }
                
                if (roleInput && !roleInput.value) {
                    e.preventDefault();
                    var customSelect = form.querySelector('.custom-select');
                    if (customSelect) {
                        customSelect.querySelector('.select-trigger').style.borderColor = '#ef4444';
                    }
                    return;
                }

                // AJAX Form Submission with reCAPTCHA
                e.preventDefault();
                var formData = new FormData(form);
                var submitBtn = form.querySelector('button[type="submit"]');
                var successDiv = document.getElementById('form-success');
                var recaptchaResponseInput = form.querySelector('input[name="g-recaptcha-response"]');
                
                // Get translations based on page language
                var pageLang = document.documentElement.lang || 'en';
                var translations = {
                    en: {
                        verifying: 'Verifying...',
                        sending: 'Sending...',
                        error: 'Something went wrong. Please try again.'
                    },
                    he: {
                        verifying: 'מאמת...',
                        sending: 'שולח...',
                        error: 'משהו לא נכון. נסה שוב.'
                    }
                };
                var t = translations[pageLang] || translations.en;
                
                // Store original button text
                if (!submitBtn.getAttribute('data-original-text')) {
                    submitBtn.setAttribute('data-original-text', submitBtn.textContent);
                }
                
                // Disable submit button and show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = t.verifying;
                
                // Execute reCAPTCHA
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.ready(function() {
                        grecaptcha.execute('6LdqIWYsAAAAAOoe-2FeQQ6BA1-nImj5peDS7QMz', {action: 'submit'})
                        .then(function(token) {
                            // Store token but don't add to form - Formspree handles reCAPTCHA separately
                            console.log('reCAPTCHA token received:', token ? 'valid' : 'invalid');
                            
                            // Update button text
                            submitBtn.textContent = t.sending;
                            
                            // Submit form without g-recaptcha-response field
                            formData.delete('g-recaptcha-response');
                            
                            // Submit form
                            return fetch(form.action, {
                                method: 'POST',
                                body: formData
                            });
                        })
                        .then(function(response) {
                            if (response.ok) {
                                // Hide form and show success message
                                form.style.display = 'none';
                                if (successDiv) {
                                    successDiv.style.display = 'block';
                                }
                            } else {
                                // Handle error - get error message from response
                                return response.text().then(function(text) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = submitBtn.getAttribute('data-original-text') || 'Submit';
                                    try {
                                        var errorData = JSON.parse(text);
                                        alert(errorData.error || t.error);
                                    } catch (e) {
                                        alert(t.error + ' (' + response.status + ')');
                                    }
                                });
                            }
                        })
                        .catch(function(error) {
                            console.error('Error:', error);
                            submitBtn.disabled = false;
                            submitBtn.textContent = submitBtn.getAttribute('data-original-text') || 'Submit';
                            alert(t.error);
                        });
                    });
                } else {
                    // Fallback if reCAPTCHA not loaded
                    submitBtn.textContent = t.sending;
                    formData.delete('g-recaptcha-response');
                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) {
                        if (response.ok) {
                            form.style.display = 'none';
                            if (successDiv) {
                                successDiv.style.display = 'block';
                            }
                        } else {
                            // Handle error - get error message from response
                            return response.text().then(function(text) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = submitBtn.getAttribute('data-original-text') || 'Submit';
                                try {
                                    var errorData = JSON.parse(text);
                                    alert(errorData.error || t.error);
                                } catch (e) {
                                    alert(t.error + ' (' + response.status + ')');
                                }
                            });
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        submitBtn.disabled = false;
                        submitBtn.textContent = submitBtn.getAttribute('data-original-text') || 'Submit';
                        alert(t.error);
                    });
                }
            });
        });
    </script>
</body>

</html>
